<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone App: Music</title>
    <link href="/css/globals.css" rel="stylesheet" type="text/css" media="all">
    <link href="css/phoneGlobals.css" rel="stylesheet" type="text/css" media="all">

    <link href="css/music.css" rel="stylesheet" type="text/css" media="all">

    <meta name="description" content="Access literally everything you need." />
    <link rel="icon" type="image/x-icon" href="../Assets/pixels/vintageAmericana/strawberryphone.webp">

    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">

    <script src="js/musicPlayer/musicPlayer.js"></script>
</head>

<body>
    <object id="detailBarObject" data="detailbar.html?theme=dark"></object>
    <h4>Now Playing</h4>
    <main>
        <div class="detailWrapper">
            <svg id="ProgressC" width="200" height="200" viewBox="0 0 200 200">
                <circle id="ProgressCBgOutline" cx="100" cy="100" r="90" stroke-width="15" />
                <circle id="ProgressCBg" cx="100" cy="100" r="90" stroke-width="10" />
                <circle id="ProgressCBar" cx="100" cy="100" r="90" stroke-width="10" />
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" id="ProgressCSun" width="50" height="50" viewBox="0 0 512 512" fill="none">
                <path id="sunPath" fill="currentColor" d="M320.063 19.72c-72.258 14.575-19.248 71.693-74.344 108.81c4.846-.49 9.746-.702 14.655-.624c16.288.26 32.785 3.72 48.594 10.72a126 126 0 0 1 14.25 7.405c12.107-47.476-37.103-96.38-3.158-126.31zM136.75 44.47c-40.76 61.357 36.984 64.33 24.406 129.405c17.407-21.255 41.17-35.9 67.156-42.313c-25.006-42.138-94.4-41.924-91.562-87.093zm297.313 75.405c-32.547.872-45.475 46.314-96.594 36.22c21.35 17.42 36.034 41.25 42.467 67.31c42.306-24.92 42.053-94.466 87.282-91.624c-13.43-8.92-24.06-12.15-33.158-11.905zm-177.97 26.656c-23.656.46-46.53 8.82-64.906 23.626l18.657 36.156L170 193.156a107.6 107.6 0 0 0-9.406 16.938c-8.726 19.708-11.002 40.59-7.78 60.344l44.78 2.125l-34 30.312c10.798 20.622 28.414 37.852 51.406 48.03a108 108 0 0 0 9.313 3.626l24.53-38.25l9.095 43.814c27.3.075 53.737-10.387 73.593-29.188l-19.186-37.125l38.406 12.658a109 109 0 0 0 5.03-9.938c9.746-22.01 11.457-45.498 6.44-67.22l-37.626-1.75l27.687-24.718c-10.83-20.194-28.236-37.07-50.874-47.093a107 107 0 0 0-4.125-1.72l-25.874 40.313l-9.906-47.75c-.5-.016-1-.023-1.5-.032c-1.3-.02-2.61-.024-3.906 0zM133.407 186.5c-41.652.725-82.483 34.847-108.72 5.094c14.573 72.234 71.664 19.3 108.783 74.312c-2.154-20.972.934-42.758 10.06-63.375a126 126 0 0 1 7.345-14.093c-5.822-1.47-11.642-2.038-17.47-1.937zm249.5 53.97a124.65 124.65 0 0 1-10.03 63.624l-.188.375a126 126 0 0 1-7.22 13.78c47.524 12.244 96.507-37.137 126.47-3.156c-14.603-72.388-71.92-19.04-109.032-74.625zM136.53 283.405c-42.123 25.014-41.928 94.37-87.093 91.53c61.422 40.803 64.322-37.123 129.594-24.342c-21.344-17.385-36.03-41.167-42.5-67.188zm219.064 48.906c-17.406 21.46-41.236 36.24-67.344 42.72c24.944 42.263 94.497 42.004 91.656 87.218c40.867-61.52-37.402-64.358-24.312-129.938M193.406 360.72c-12.047 47.456 37.087 96.33 3.156 126.25c72.305-14.587 19.195-71.79 74.47-108.908c-21.04 2.204-42.898-.9-63.594-10.062a126 126 0 0 1-14.032-7.28"/>
            </svg>

            <!-- <img id="albumCover" class="albumCover" src="/Assets/other/albumCovers/fallbackCover.jpg" alt="Album Cover"> -->
            <img id="albumCover" class="albumCover"
                src="/Assets/other/albumCovers/holiday/christmas/BabyPleaseComeHomeCover.jpeg" alt="Album Cover">

        </div>

        <div class="songInfoWrapper">
            <div class="timeDisplay">
                <p id="currentTimeDisplay">0:00</p>
                <p id="slash">/</p>
                <p id="durationTimeDisplay">0:00</p>
            </div>

            <p id="songName">Track Name</p>
            <p id="songArtist">Artist</p>
        </div>

        <div class="controlsWrapper">
            <button id="shuffleButton" class="tinyButtons">
                <iconify-icon icon="jam:shuffle"></iconify-icon>
            </button>

            <button id="seekBack" class="buttonsBase">
                <iconify-icon icon="qlementine-icons:seek-backward-16"></iconify-icon>
            </button>

            <button id="MusicPauseButton" class="buttonsBase">
                <iconify-icon icon="line-md:loading-loop"></iconify-icon></iconify-icon>
            </button>

            <button id="seekForward" class="buttonsBase">
                <iconify-icon icon="qlementine-icons:seek-forward-16"></iconify-icon>
            </button>
            <button id="loopButton" class="tinyButtons">
                <iconify-icon icon="radix-icons:loop"></iconify-icon>
            </button>
        </div>

        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.1" title="Volume">
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            await createAudioPlayer();

            controlsSetUp();
            setupMusicPageUI();

            const savedTime = sessionStorage.getItem('currentSongTime');
            if (savedTime) {
                audioPlayer.currentTime = parseFloat(savedTime);
            }

            const isPaused = JSON.parse(sessionStorage.getItem('isPaused')) || false;
            // console.log(`isPaused state on load: ${isPaused}`);

            if (!isPaused) {
                // console.log("Music is Playing!");
                audioPlayer.play();
                document.getElementById('MusicPauseButton').innerHTML = `<iconify-icon icon="qlementine-icons:pause-16"></iconify-icon>`;
            } else {
                // console.log("Music is Paused!");
                document.getElementById('MusicPauseButton').innerHTML = `<iconify-icon icon="qlementine-icons:play-16"></iconify-icon>`;
            }
        });

        function controlsSetUp() {
            if (!audioPlayer) {
                console.error("Audio player is not initialized yet.");
                return;
            }

            const pauseButton = document.getElementById('MusicPauseButton');
            if (pauseButton) {
                pauseButton.addEventListener('click', PauseNPlay);
                updatePauseButton();
            }

            const seekBackButton = document.getElementById('seekBack');
            if (seekBackButton) {
                seekBackButton.addEventListener('click', seekBackward);
            }

            const seekForwardButton = document.getElementById('seekForward');
            if (seekForwardButton) {
                seekForwardButton.addEventListener('click', seekForward);
            }

            const loopButton = document.getElementById('loopButton');
            if (loopButton) {
                loopButton.addEventListener('click', toggleLoop);
            }

            const shuffleButton = document.getElementById('shuffleButton');
            if (shuffleButton) {
                shuffleButton.addEventListener('click', toggleShuffle);
            }
        }

        function setupMusicPageUI() {
            if (!audioPlayer) {
                console.error("Audio player is not initialized yet.");
                return;
            }

            // For the progress bar
            const ProgressCSun = document.getElementById('ProgressCSun');
            const sunPath = document.getElementById('sunPath');
            let rotationOffset = 0;
            const rotationsPerSecond = 0.15; // Rotations in place
            sunPath.style.transformOrigin = "50% 50%";
            sunPath.style.transition = "transform 1s, left 1s, top 1s";
            ProgressCSun.style.left = '50%';
            ProgressCSun.style.top = '50%';

            // Volume Slider
            const volumeSlider = document.getElementById('volumeSlider');
            if (volumeSlider) {
                volumeSlider.value = .1;
                volumeSlider.addEventListener('input', function () {
                    audioPlayer.volume = parseFloat(volumeSlider.value);
                    sessionStorage.setItem('songVolume', volumeSlider.value);
                    volumeSlider.setAttribute('title', `Volume: ${volumeSlider.value}`);
                });
            }

            const currentTimeDisplay = document.getElementById('currentTimeDisplay');
            if (currentTimeDisplay) {
                audioPlayer.addEventListener('timeupdate', function () {
                    const currentTime = audioPlayer.currentTime;
                    const minutes = Math.floor(currentTime / 60);
                    const seconds = Math.floor(currentTime % 60);
                    currentTimeDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                    updateProgressBar(currentTime, audioPlayer.duration, ProgressCSun);
                });
            }

            // Update song duration when metadata is loaded
            audioPlayer.addEventListener('loadedmetadata', function () {
                const duration = Math.floor(audioPlayer.duration);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const formattedDuration = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                sessionStorage.setItem('songDuration', formattedDuration);
                document.getElementById('durationTimeDisplay').innerText = formattedDuration;
            });
        }

        function updateProgressBar(currentTime, duration, ProgressCSun) {
            const progressCBar = document.getElementById('ProgressCBar');
            if (!progressCBar) return;

            const progress = (currentTime / duration) * 565;
            progressCBar.style.strokeDashoffset = 565 - progress;

            if (ProgressCSun) {
                const radius = 90;
                const angle = (currentTime / duration) * 360;
                const radians = (angle - 90) * (Math.PI / 180);
                const starX = radius * Math.cos(radians);
                const starY = radius * Math.sin(radians);

                ProgressCSun.style.left = '50%';
                ProgressCSun.style.top = '50%';
                ProgressCSun.style.transform = `translate(${starX - 20}px, ${starY - 20}px)`;

                const rotationsPerSecond = 0.15;
                sunPath.style.transform = `rotate(${currentTime * rotationsPerSecond * 360}deg)`;
            }
        }

        function updateMetadata(index) {
            const song = songs[index];
            if (!song) return;

            // Update song name and artist
            document.getElementById('songName').innerText = song.title;
            document.getElementById('songArtist').innerText = song.writer;

            const albumCoverElement = document.getElementById('albumCover');
            if (albumCoverElement) {
                albumCoverElement.src = song.cover || "/Assets/other/albumCovers/fallbackCover.jpg";
                albumCoverElement.alt = `${song.title} Album Cover`;
            }
            // console.log(`Updated metadata for ${song.title}`);
        }

        function PauseNPlay() {
            const isPaused = audioPlayer.paused;

            // console.log('PauseNPlay called');
            // console.log(`Audio paused state: ${isPaused}`);

            if (isPaused) {
                audioPlayer.play();
                sessionStorage.setItem('isPaused', 'false');
                // console.log("Music is Playing! SessionStorage isPaused: false");
            } else {
                audioPlayer.pause();
                sessionStorage.setItem('isPaused', 'true');
                // console.log("Music is Paused! SessionStorage isPaused: true");
            }

            updatePauseButton();
        }

        function updatePauseButton() {
            const pauseButton = document.getElementById('MusicPauseButton');
            if (audioPlayer.paused) {
                pauseButton.innerHTML = `<iconify-icon icon="qlementine-icons:play-16"></iconify-icon>`;
            } else {
                pauseButton.innerHTML = `<iconify-icon icon="qlementine-icons:pause-16"></iconify-icon>`;
            }
        }

        // Loop Mode
        function toggleLoop() {
            loopMode = !loopMode;
            this.classList.toggle('active', loopMode);
            sessionStorage.setItem('loopMode', loopMode);
        }

        // Shuffle Mode
        function toggleShuffle() {
            shuffleMode = !shuffleMode;
            this.classList.toggle('active', shuffleMode);

            if (shuffleMode) {
                shuffleOrder = [...Array(songs.length).keys()];
                shuffleArray(shuffleOrder);
                currentShuffleIndex = 0;
            } else {
                shuffleOrder = [...Array(songs.length).keys()];
            }

            sessionStorage.setItem('shuffleMode', shuffleMode);
        }

    </script>
</body>

</html>